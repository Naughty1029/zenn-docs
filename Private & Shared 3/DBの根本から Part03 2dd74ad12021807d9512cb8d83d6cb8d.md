# DBの根本から Part03

## **第7章：2000年代 - クラウドの夜明け**

### **従来のDB運用の大変さ**

<aside>
😈

2000年代初頭、Webサービスを運営するのは本当に大変でした。

</aside>

**ステップ1：サーバー購入**

- **エンジニア**：「DBサーバー買わないと」
- **CFO（最高財務責任者）**：「いくら？」
- **エンジニア**：「本体50万、メモリ20万、ディスク30万...計100万円」
- **CFO**：「...」

<aside>
😀

初期費用だけで100万円！

</aside>

<aside>
😈

しかも、サーバーを買っても、すぐには使えません。

</aside>

**ステップ2：セットアップ**

1. サーバーをデータセンターに配送
2. ラックに設置（物理作業）
3. OSインストール（Linux）
4. MySQLインストール
5. 設定ファイルを編集
6. セキュリティ設定
7. バックアップスクリプト作成
8. 監視設定

**所要時間：2〜3日**

<aside>
😀

めんどくさい…

</aside>

<aside>
😈

さらに、運用中も大変なんです。

</aside>

**ステップ3：運用開始後の悪夢**

**深夜2時**

`🚨 アラート「ディスク使用率95%！」`

**エンジニア**：「やばい！」

→ データセンターに駆けつける

→ ディスク増設（物理作業）

→ データ移行

→ 朝6時帰宅...

<aside>
😀

つらすぎる…

</aside>

<aside>
😈

これが現実でした。そして、さらに大きな問題がスケーリングです。

急成長するWebサービスの典型的なシナリオを見てみましょう。

</aside>

- **シナリオ：急成長するWebサービス**
    - **月曜日**
    - ユーザー数：1,000人
    - DBサーバー：1台で快適 😊
- **金曜日**
    - ユーザー数：10,000人
    - DBサーバー：処理が追いつかない... 😱

<aside>
😀

10倍になった！どうするの？

</aside>

<aside>
😈

2つの対策がありますが、どちらも大変なんです。

</aside>

<aside>
😈

対策の1つめが、垂直スケーリング（スケールアップ）です。

つまり、より高性能なサーバーに交換する方法です。

しかし、数百万円の追加投資が必要だったり、データを新サーバー移行するためのダウンタイムが必要だったりします。そして、上限があるため、いつか限界に達するという課題があります。

</aside>

<aside>
😀

お金も時間もかかるんだ...

</aside>

<aside>
😈

対策2つめが水平スケーリング（スケールアウト）です。

サーバーを複数台に分散する方法です。

</aside>

<aside>
😈

```
    [Webサーバー]
          ↓
    [マスターDB] ← 書き込み専用
     ↓     　　　↓
[スレーブDB1] [スレーブDB2] ← 読み取り専用
```

仕組みとしては、マスターDBに書き込んだデータを、スレーブDBにコピー（レプリケーション）します。

読み取りは複数のスレーブに分散できるので、負荷が分散されます。

</aside>

<aside>
😈

しかし問題点はあります。

- レプリケーションの設定が複雑

```sql
-- マスター側
GRANT REPLICATION SLAVE ON *.* TO 'repl'@'%';
SHOW MASTER STATUS;

-- スレーブ側
CHANGE MASTER TO MASTER_HOST='192.168.1.10', ...;
START SLAVE;
```

- 読み取りは分散できても、書き込みは難しい
    - 書き込みは全てマスターに集中
    - マスターがボトルネックになる
- データの整合性を保つのが困難
    - レプリケーションには遅延がある
    - マスターとスレーブでデータが一時的に異なる
    - アプリ側で制御が必要
</aside>

<aside>
😀

どうすればいいの...

</aside>

<aside>
😈

そこで、Amazonが歴史を変えます。

</aside>

### AWS（Amazon Web Services）の誕生

<aside>
😈

2000年代初頭、Amazon.comは独自の問題を抱えていました。

- **Amazonの課題**
    - **クリスマスシーズン**
    - アクセスが爆増
    - 大量のサーバーが必要
- **普段**
    - サーバーに余裕がある
    - リソースが余っている
- **問題**
    - 年中、ピーク時に合わせてサーバーを用意
    - 大量のサーバーが普段は遊んでいる
    - 無駄なコスト
</aside>

<aside>
😈

そこで、eff Bezos（ジェフ・ベゾス）CEOが発想したんです。

「うちの余ったサーバーリソース、他の会社に貸し出せないかな？」

これが**クラウドコンピューティング**の始まりでした。

</aside>

<aside>
😈

2006年3月14日にAmazon Web Services発表されました。

最初のサービスは2つでした。

**最初のサービス**

1. **S3（Simple Storage Service）**
    - ファイル保存サービス
    - 容量無制限（実質）
    - 従量課金
2. **EC2（Elastic Compute Cloud）**
    - 仮想サーバーサービス
    - 必要な時に数分で起動
    - 使った分だけ課金
</aside>

<aside>
😀

仮想サーバー？

</aside>

<aside>
😈

物理的なサーバーを買う必要がなく、ソフトウェアとして「サーバー」を借りられるんです。

</aside>

### **クラウドコンピューティングの革命**

<aside>
😈

従来の方法と比較してみましょう。

</aside>

**従来（オンプレミス）**

| ステップ | 内容 | 時間 | コスト |
| --- | --- | --- | --- |
| 1 | サーバー購入 | - | 100万円 |
| 2 | 配送待ち | 1週間 | - |
| 3 | セットアップ | 2〜3日 | - |
| 4 | 使い始める | - | - |
| **合計** | - | **約10日** | **100万円+** |

**問題点**

- 初期投資が大きい
- スケールに時間がかかる
- 使わなくなっても資産として残る
- 障害時の対応が大変

**AWS（クラウド）**

| ステップ | 内容 | 時間 | コスト |
| --- | --- | --- | --- |
| 1 | AWSにログイン | 1分 | 0円 |
| 2 | インスタンス起動 | 2分 | 時間課金 |
| 3 | 使い始める | - | - |
| **合計** | - | **数分** | **月数千円〜** |

**メリット**

- 初期投資ゼロ（従量課金）
- 即座にスケール
- 使わなければ料金もかからない
- 障害対応はAWSが担当

<aside>
😀

これは...革命だ！

</aside>

<aside>
😈

そう！でもまだDBの話じゃないんです。

EC2はただの仮想サーバー。この上にMySQLを自分でインストールする必要がありました。

</aside>

### クラウド初期のDB運用

<aside>
😈

AWSが登場した当初、DBの運用はまだ大変でした。

</aside>

- **EC2上でMySQLを運用**

```bash
# EC2インスタンスにSSH接続
ssh ec2-user@your-instance

# MySQLをインストール
sudo apt-get install mysql-server

# 設定ファイルを編集
sudo vim /etc/mysql/my.cnf

# バックアップスクリプトを作成
# 監視設定...
# セキュリティ設定...
```

<aside>
😈

結局、サーバーの管理は自分でやらないといけなかった。

でも、この状況も変わります。

</aside>

### RDS（Relational Database Service）の登場：2009年10月

<aside>
😈

AWSが「データベースも管理します」というサービスを開始しました。

</aside>

- RDSの革新
    - 従来（EC2上のMySQL）
        - やること
            - サーバーのOSアップデート
            - MySQLのインストール
            - MySQLのバージョンアップ
            - バックアップスクリプト作成
            - レプリケーション設定
            - 監視設定
            - セキュリティパッチ適用
            - ディスク容量管理
    - RDS
        - やること：
            - データベースを使う（だけ！）
        - AWSがやってくれること：
            - OSアップデート
            - バックアップ（自動）
            - レプリケーション（ボタン1つ）
            - 監視（自動）
            - セキュリティパッチ（自動）
            - ディスク拡張（自動）

<aside>
😀

めちゃくちゃ楽になった！

</aside>

<aside>
😈

そうなんです！エンジニアは「データベースの管理」ではなく「アプリケーションの開発」に集中できるようになったんです。

</aside>

### 競合の登場

<aside>
😈

AWSの成功を見て、他の大手IT企業も参入しました。

</aside>

**主なクラウドプロバイダー**

| サービス | 会社 | 開始年 | DB サービス |
| --- | --- | --- | --- |
| **AWS** | Amazon | 2006 | RDS (2009) |
| **Azure** | Microsoft | 2010 | Azure SQL Database |
| **GCP** | Google | 2008 | Cloud SQL (2011) |

<aside>
😈

クラウドデータベースの登場で、何が変わったと思いますか？

</aside>

1. **スタートアップの参入障壁がさらに低下**
    1. **2005年**
        1. 最小構成でも数百万円の初期投資
        2. 大きなリスク
    2. **2010年**
        1. 月数千円から始められる
        2. アイデアをすぐに試せる
2. **グローバル展開が容易に**

<aside>
😈

世界中のリージョンにボタン1つでデプロイできるようになりました。

従来：

- 各国にデータセンターを契約
- 各国にサーバーを配送・設置
- 各国のエンジニアが管理

クラウド：

- リージョンを選択
- ボタンをクリック
- 数分で世界中に展開
</aside>

1. **運用からの解放**

<aside>
😈

エンジニアが深夜に駆り出されることが減りました。

- 従来
    - 深夜2時「ディスク容量が...」
        - → データセンターへ
- クラウド
    - 深夜2時「ディスク容量が...」
        - → 自動で拡張される（場合によっては手動でボタンクリック）
</aside>

1. **実験のコストが下がった**

<aside>
😈

「試してみる」ことが気軽にできるようになりました。

- 従来
    - 新しい技術を試すにはサーバー購入が必要
    - 失敗したら数百万円の損失
- クラウド
    - 数時間だけ使えば数十円
    - 失敗してもリスクが小さい
</aside>

<aside>
😀

クラウドで世界が変わったんだね！

</aside>

<aside>
😈

その通り！でも、クラウド時代には新しい課題も生まれました。

次の章では、RDBMSの限界と、それを打破する**NoSQL**の登場を見ていきます。

</aside>

---

## **第8章：RDS - データベースのマネージドサービス（2009年）**

### **DBの運用、やっぱり大変問題**

<aside>
😈

第7章でRDSの誕生を見ましたが、この章ではRDSの詳細機能を深く理解していきましょう。改めて、RDSが自動でやってくれることを紹介します。

</aside>

1. **自動バックアップ**

<aside>
😈

毎日自動でバックアップを取得してくれます。

- 設定
    - バックアップ保持期間：1〜35日
    - バックアップウィンドウ：深夜2時〜3時など指定可能
    - 自動で古いバックアップを削除
    
    → スクリプト書く必要なし！
    
</aside>

1. **自動パッチ適用**

<aside>
😈

セキュリティ更新を自動で適用してくれます。

- 設定
    - メンテナンスウィンドウを設定
    例：毎週日曜日の深夜3時〜4時
    - 指定した時間に自動でパッチ適用
    
    → 深夜作業から解放！
    
</aside>

1. **簡単なスケーリング**

<aside>
😈

Webコンソールでボタンをクリックするだけ。

- 従来：
    1. 新しいサーバー購入
    2. データ移行
    3. 切り替え
    所要時間：数日
- RDS
    1. インスタンスタイプを選択
    2. 「変更を適用」をクリック
    所要時間：数分〜数十分
</aside>

1. **高可用性（Multi-AZ）**

<aside>
😈

自動で別のデータセンター（AZ）にレプリカを作成してくれます。

- メインが故障したら：
→ 自動でフェイルオーバー
→ ダウンタイム約1〜2分
</aside>

1. **監視**

<aside>
😈

すべてのメトリクスが自動で可視化されます。

- 監視項目：
- CPU使用率
- メモリ使用率
- ディスクI/O
- ネットワークトラフィック
- データベース接続数
    - etc

全部グラフで可視化

アラートも簡単設定

</aside>

<aside>
😀

これは...エンジニアの救世主だ！

</aside>

<aside>
😈

でしょ？これが「**マネージドサービス**」という概念です。

</aside>

### **RDSのアーキテクチャ理解**

<aside>
😈

ここで重要な理解をしておきましょう。

RDSとは何か？

- **重要な概念：RDS ≠ DBMS**
    - **RDS** = 管理サービス
    - **MySQL/PostgreSQLなど** = DBMSエンジン
</aside>

<aside>
😀

なるほど！RDSは「管理してくれるサービス」で、その中でMySQLとかを選ぶんだね。

</aside>

### **Multi-AZ：高可用性の仕組み**

<aside>
😈

RDSの最も重要な機能の一つが**Multi-AZ**です。

</aside>

<aside>
😀

アベイラビリティゾーン？

</aside>

<aside>
😈

AWSのデータセンターの単位です。

異なるAZは物理的に離れた場所にあるので、片方が災害で停止しても、もう片方は動き続けます。

普段は、マスターDBだけが使われます。

スタンバイDBは待機しているだけで、アプリケーションから接続できません。

</aside>

<aside>
😈

しかし障害が発生すると、ファイルオーバーといって、こんな流れで自動復旧します。

</aside>

1. **障害検知**（約1分）
    1. RDSがマスターDBの異常を検知
        1. ヘルスチェック失敗
        2. ネットワーク断絶
2. **自動フェイルオーバー**（約1〜2分）
    1. スタンバイDBを新しいマスターに昇格
    2. DNSエンドポイントを自動更新
3. **アプリケーションの再接続**
    1. アプリは同じ接続文字列を使い続ける
    2. 自動的に新しいマスターに接続

<aside>
😀

すごい！自動で復旧するんだ！

</aside>

<aside>
😈

そうなんです。従来なら、エンジニアが深夜に駆けつけて手動で復旧作業をしていました。Multi-AZならそれが自動化されるんです。

</aside>

### **リードレプリカ：性能向上の仕組み**

<aside>
😈

Multi-AZは「高可用性」のためですが、**リードレプリカ**は「性能向上」のためです。

ECサイトで考えてみましょう。

</aside>

**書き込み処理（マスターへ）**

```sql
-- 注文を作成（書き込み）
INSERT INTO orders (user_id, product_id, quantity)
VALUES (123, 456, 2);

-- 在庫を更新（書き込み）
UPDATE products SET stock = stock - 2
WHERE product_id = 456;

```

**読み取り処理（リードレプリカへ）**

```sql
-- 商品一覧を表示（読み取り）
SELECT * FROM products
WHERE category = '家電';

-- ユーザー履歴を表示（読み取り）
SELECT * FROM orders
WHERE user_id = 123;

-- 売上レポート（読み取り）
SELECT DATE(created_at), SUM(amount)
FROM orders
GROUP BY DATE(created_at);

```

<aside>
😈

一般的に、Webサービスは「読み取り」の方が圧倒的に多いんです。

- 読み取り：書き込み = **90%：10%** くらい

だから、読み取りを分散させるだけで大きな効果があります。

</aside>

**アプリケーション側の設定例**

```python
# Pythonの例
import mysql.connector

# マスターDB（書き込み用）
master_db = mysql.connector.connect(
    host="master.xxxxx.rds.amazonaws.com",
    user="admin",
    password="password"
)

# リードレプリカ（読み取り用）
read_db = mysql.connector.connect(
    host="read-replica.xxxxx.rds.amazonaws.com",
    user="admin",
    password="password"
)

# 書き込みはマスターへ
cursor = master_db.cursor()
cursor.execute("INSERT INTO orders ...")

# 読み取りはリードレプリカへ
cursor = read_db.cursor()
cursor.execute("SELECT * FROM products ...")

```

### **Multi-AZ vs リードレプリカ**

<aside>
😀

Multi-AZとリードレプリカ、似てるけど違うの？

</aside>

<aside>
😈

目的が全く違います。比較してみましょう。

- **Multi-AZ**で障害に備える
- **リードレプリカ**で性能を向上
</aside>

| 項目 | Multi-AZ | リードレプリカ |
| --- | --- | --- |
| **目的** | 高可用性（障害対策） | 性能向上（負荷分散） |
| **スタンバイDBへの接続** | できない（待機専用） | できる（読み取り可能） |
| **レプリケーション** | 同期（リアルタイム） | 非同期（若干遅延） |
| **フェイルオーバー** | 自動 | 手動（スタンバイではない） |
| **コスト** | 約2倍 | 台数分 |
| **典型的な構成** | 2台（マスター+スタンバイ） | 1〜15台 |
| **データの整合性** | 完全に同期 | 数秒〜数分の遅延あり |

### **他のクラウドプロバイダーのマネージドDB**

<aside>
😈

AWSの成功を見て、他のクラウドプロバイダーも独自のマネージドDBサービスを開発しました。

</aside>

**主なマネージドDBサービス**

| プロバイダー | サービス | 対応エンジン | 特徴 | 開始年 |
| --- | --- | --- | --- | --- |
| **AWS** | RDS | MySQL, PostgreSQL, MariaDB, Oracle, SQL Server | 最も種類が豊富 | 2009 |
| **Google** | Cloud SQL | MySQL, PostgreSQL, SQL Server | シンプル、安価 | 2011 |
| **Microsoft** | Azure SQL Database | SQL Server | SQL Server特化 | 2010 |
| **Microsoft** | Azure Database for MySQL/PostgreSQL | MySQL, PostgreSQL | オープンソース対応 | 2016 |

**Google Cloud SQL の特徴**

<aside>
😈

Googleのアプローチはシンプルさを重視しています

</aside>

- 特徴
    - 設定が非常にシンプル
    - 価格が比較的安い
    - Google Cloud の他サービスとの連携が強い
    - 自動ストレージ拡張
- 制限
    - RDSほど細かい設定ができない
    - 対応エンジンが少ない

**Azure SQL Database の特徴**

<aside>
😈

MicrosoftはSQL Serverに特化した最適化をしています。

</aside>

- 特徴
    - SQL Serverとの完全互換
    - Windows環境との親和性が高い
    - エンタープライズ向け機能が充実
    - サーバーレスオプションあり
- 向いている
    - 既存のSQL Serverから移行したい企業
    - Microsoftエコシステムを使っている企業

### **マネージドDBがもたらした変化**

<aside>
😈

マネージドデータベースの登場で、運用の負担は大きく減りました。

でも、RDSにも限界がありました。既存のDBMS（MySQLやPostgreSQL）をクラウド上で便利に使えるようにしただけで、DBMS自体の根本的な制限は残っていたんです。

次の章では、**クラウド専用に設計された革新的なデータベース、Amazon Aurora**を見ていきます。

</aside>